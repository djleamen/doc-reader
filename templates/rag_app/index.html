{% extends 'base.html' %}

{% block content %}
<div class="row">
    
    <!-- Sidebar -->
    <div class="col-md-3">
        <div class="glass-card">
            <h5 class="text-white"><i class="fas fa-cog"></i> Configuration</h5>
            
            <!-- Index Selection -->
            <div class="mb-3">
                <label for="indexSelect" class="form-label text-white">Index Name</label>
                <select class="form-select" id="indexSelect">
                    <option value="default" selected>default</option>
                    {% for index in indexes %}
                        <option value="{{ index.name }}">{{ index.name }}</option>
                    {% endfor %}
                </select>
                <small class="text-white-50">Select or create document index</small>
            </div>
            
            <!-- Query Settings -->
            <h6 class="text-white mt-4">Query Settings</h6>
            
            <div class="mb-3">
                <label for="maxResults" class="form-label text-white">Max Results</label>
                <input type="range" class="form-range" id="maxResults" min="1" max="20" value="5">
                <small class="text-white-50">Max documents to retrieve: <span id="maxResultsValue">5</span></small>
            </div>
            
            <div class="form-check mb-2">
                <input class="form-check-input" type="checkbox" id="includeSources" checked>
                <label class="form-check-label text-white" for="includeSources">
                    Include Sources
                </label>
            </div>
            
            <div class="form-check mb-2">
                <input class="form-check-input" type="checkbox" id="includeScores" checked>
                <label class="form-check-label text-white" for="includeScores">
                    Include Confidence Scores
                </label>
            </div>
            
            <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="conversationalMode">
                <label class="form-check-label text-white" for="conversationalMode">
                    Conversational Mode
                </label>
            </div>
            
            <!-- Index Statistics -->
            <h6 class="text-white mt-4">
                <i class="fas fa-chart-bar"></i> Index Statistics
                <button class="btn btn-sm btn-outline-light ms-2" id="refreshStats" title="Refresh Statistics">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </h6>
            
            <div id="indexStats" class="mt-3">
                <div class="stat-card">
                    <div class="stat-value" id="documentCount">-</div>
                    <small>Documents</small>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="chunkCount">-</div>
                    <small>Chunks</small>
                </div>
            </div>
            
            <!-- Clear Conversation -->
            <div id="conversationalControls" class="mt-4 hidden">
                <button class="btn btn-warning btn-sm w-100" id="clearConversation">
                    <i class="fas fa-trash"></i> Clear Conversation
                </button>
            </div>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="col-md-9">
        
        <!-- Document Upload Section -->
        <div class="glass-card">
            <h5 class="text-white"><i class="fas fa-upload"></i> Upload Documents</h5>
            
            <form id="uploadForm" enctype="multipart/form-data">
                {% csrf_token %}
                
                <div class="drag-drop-area" id="dragDropArea">
                    <i class="fas fa-cloud-upload-alt fa-3x mb-3"></i>
                    <h6 class="text-white">Drag & drop files here or click to select</h6>
                    <p class="text-white-50">
                        Supported formats: {{ supported_formats|join:", "|upper }}
                        <br>
                        Max file size: {{ max_file_size_mb }} MB
                    </p>
                    <input type="file" id="fileInput" multiple 
                           accept=".pdf,.docx,.txt,.md"
                           class="hidden"
                           aria-label="Select files to upload">
                </div>
                
                <!-- Selected Files -->
                <div id="selectedFiles" class="mt-3 hidden">
                    <h6 class="text-white">Selected Files:</h6>
                    <ul id="fileList" class="list-group"></ul>
                </div>
                
                <!-- Upload Button -->
                <div class="mt-3 text-center">
                    <button type="button" id="uploadBtn" class="btn btn-primary btn-lg" disabled>
                        <i class="fas fa-rocket"></i> Process Documents
                    </button>
                </div>
                
                <!-- Upload Progress -->
                <div id="uploadProgress" class="mt-3 hidden">
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" 
                             aria-label="Document upload progress"
                             aria-valuenow="0" 
                             aria-valuemin="0" 
                             aria-valuemax="100"
                             class="progress-bar-initial"></div>
                    </div>
                    <div class="text-center text-white mt-2">
                        <span id="uploadStatus">Processing...</span>
                    </div>
                </div>
                
                <!-- Upload Results -->
                <div id="uploadResults" class="mt-3"></div>
            </form>
        </div>
        
        <!-- Query Section -->
        <div class="glass-card">
            <h5 class="text-white"><i class="fas fa-question-circle"></i> Ask Questions</h5>
            
            <!-- Sample Questions -->
            <div class="mb-3">
                <h6 class="text-white">
                    <i class="fas fa-lightbulb"></i> Sample Questions
                    <button class="btn btn-sm btn-outline-light ms-2" type="button" 
                            data-bs-toggle="collapse" data-bs-target="#sampleQuestions"
                            title="Toggle sample questions">
                        <i class="fas fa-chevron-down"></i>
                    </button>
                </h6>
                
                <div class="collapse" id="sampleQuestions">
                    <div class="sample-question" onclick="setQuestion(this)">
                        What are the main topics covered in the documents?
                    </div>
                    <div class="sample-question" onclick="setQuestion(this)">
                        Can you summarize the key findings?
                    </div>
                    <div class="sample-question" onclick="setQuestion(this)">
                        What methodology was used in the research?
                    </div>
                    <div class="sample-question" onclick="setQuestion(this)">
                        What are the conclusions and recommendations?
                    </div>
                </div>
            </div>
            
            <!-- Query Form -->
            <form id="queryForm">
                {% csrf_token %}
                <div class="mb-3">
                    <label for="questionInput" class="form-label text-white">Your Question:</label>
                    <textarea class="form-control" id="questionInput" rows="3" 
                              placeholder="Ask any question about your uploaded documents..."></textarea>
                </div>
                
                <div class="text-center">
                    <button type="submit" class="btn btn-primary btn-lg" id="askBtn">
                        <i class="fas fa-search"></i> Ask Question
                    </button>
                </div>
            </form>
            
            <!-- Query Progress -->
            <div id="queryProgress" class="text-center mt-3 hidden">
                <div class="spinner-border" role="status"></div>
                <div class="text-white mt-2">Searching for answers...</div>
            </div>
        </div>
        
        <!-- Results Section -->
        <div id="resultsSection" class="hidden">
            
            <!-- Answer -->
            <div class="glass-card">
                <h5 class="text-white"><i class="fas fa-comment-dots"></i> Answer</h5>
                <div id="answerContent" class="text-white"></div>
            </div>
            
            <!-- Query Details -->
            <div class="glass-card">
                <h6 class="text-white">
                    <i class="fas fa-chart-line"></i> Query Details
                    <button class="btn btn-sm btn-outline-light ms-2" type="button"
                            data-bs-toggle="collapse" data-bs-target="#queryDetails"
                            title="Toggle query details">
                        <i class="fas fa-chevron-down"></i>
                    </button>
                </h6>
                
                <div class="collapse" id="queryDetails">
                    <div class="row text-center" id="queryMetrics">
                        <!-- Metrics will be populated by JavaScript -->
                    </div>
                </div>
            </div>
            
            <!-- Source Documents -->
            <div id="sourceDocuments" class="glass-card hidden">
                <h5 class="text-white"><i class="fas fa-book"></i> Source Documents</h5>
                <div id="sourceList">
                    <!-- Source documents will be populated by JavaScript -->
                </div>
            </div>
            
        </div>
        
    </div>
    
</div>

<!-- Conversation History Modal -->
<div class="modal fade" id="conversationModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content modal-glass">
            <div class="modal-header border-0">
                <h5 class="modal-title text-white">
                    <i class="fas fa-comments"></i> Conversation History
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" title="Close"></button>
            </div>
            <div class="modal-body">
                <div id="conversationHistory" class="text-white">
                    <!-- Conversation history will be populated here -->
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    let selectedFiles = [];
    let currentIndexName = 'default';
    let conversationHistory = [];
    
    // Initialize
    initializeEventListeners();
    loadIndexStats();
    
    function initializeEventListeners() {
        // File input handling
        $('#dragDropArea, #fileInput').on('click', function() {
            $('#fileInput').click();
        });
        
        $('#fileInput').on('change', handleFileSelection);
        
        // Drag and drop
        $('#dragDropArea').on('dragover', function(e) {
            e.preventDefault();
            $(this).addClass('drag-over');
        });
        
        $('#dragDropArea').on('dragleave', function(e) {
            e.preventDefault();
            $(this).removeClass('drag-over');
        });
        
        $('#dragDropArea').on('drop', function(e) {
            e.preventDefault();
            $(this).removeClass('drag-over');
            handleFileSelection(e);
        });
        
        // Form submissions
        $('#uploadBtn').on('click', uploadDocuments);
        $('#queryForm').on('submit', handleQuery);
        
        // Settings
        $('#maxResults').on('input', function() {
            $('#maxResultsValue').text($(this).val());
        });
        
        $('#conversationalMode').on('change', function() {
            $('#conversationalControls').toggle($(this).is(':checked'));
        });
        
        $('#indexSelect').on('change', function() {
            currentIndexName = $(this).val();
            loadIndexStats();
        });
        
        // Actions
        $('#refreshStats').on('click', loadIndexStats);
        $('#clearConversation').on('click', clearConversation);
    }
    
    function handleFileSelection(e) {
        let files = e.target.files || e.originalEvent.dataTransfer.files;
        selectedFiles = Array.from(files);
        
        if (selectedFiles.length > 0) {
            displaySelectedFiles();
            $('#uploadBtn').prop('disabled', false);
        }
    }
    
    function displaySelectedFiles() {
        let fileList = $('#fileList');
        fileList.empty();
        
        selectedFiles.forEach((file, index) => {
            let listItem = $(`
                <li class="list-group-item d-flex justify-content-between align-items-center file-list-item">
                    <span>
                        <i class="fas fa-file"></i> ${file.name} 
                        <small>(${(file.size / 1024 / 1024).toFixed(2)} MB)</small>
                    </span>
                    <button class="btn btn-sm btn-outline-danger" onclick="removeFile(${index})" title="Remove file">
                        <i class="fas fa-times"></i>
                    </button>
                </li>
            `);
            fileList.append(listItem);
        });
        
        $('#selectedFiles').show();
    }
    
    window.removeFile = function(index) {
        selectedFiles.splice(index, 1);
        if (selectedFiles.length > 0) {
            displaySelectedFiles();
        } else {
            $('#selectedFiles').hide();
            $('#uploadBtn').prop('disabled', true);
        }
    }
    
    function uploadDocuments() {
        if (selectedFiles.length === 0) return;
        
        let formData = new FormData();
        formData.append('index_name', currentIndexName);
        
        selectedFiles.forEach(file => {
            formData.append('files', file);
        });
        
        // Add CSRF token
        formData.append('csrfmiddlewaretoken', $('[name=csrfmiddlewaretoken]').val());
        
        $('#uploadProgress').show();
        $('#uploadBtn').prop('disabled', true);
        
        $.ajax({
            url: '/api/upload-documents/',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            xhr: function() {
                let xhr = new window.XMLHttpRequest();
                xhr.upload.addEventListener("progress", function(evt) {
                    if (evt.lengthComputable) {
                        let percentComplete = evt.loaded / evt.total * 100;
                        $('.progress-bar').css('width', percentComplete + '%');
                    }
                }, false);
                return xhr;
            },
            success: function(response) {
                displayUploadResults(response, 'success');
                loadIndexStats();
                resetUploadForm();
            },
            error: function(xhr) {
                let errorMsg = 'Upload failed';
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMsg = xhr.responseJSON.error;
                }
                displayUploadResults({error: errorMsg}, 'error');
                $('#uploadBtn').prop('disabled', false);
            },
            complete: function() {
                $('#uploadProgress').hide();
                $('.progress-bar').css('width', '0%');
            }
        });
    }
    
    function displayUploadResults(response, type) {
        let resultsDiv = $('#uploadResults');
        resultsDiv.empty();
        
        if (type === 'success') {
            let alertDiv = $(`
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i> ${response.message}
                </div>
            `);
            
            if (response.files_processed && response.files_processed.length > 0) {
                let filesList = response.files_processed.map(f => `<li>${f}</li>`).join('');
                alertDiv.append(`
                    <div class="mt-2">
                        <strong>Processed files:</strong>
                        <ul>${filesList}</ul>
                    </div>
                `);
            }
            
            if (response.total_chunks_added > 0) {
                alertDiv.append(`
                    <div class="mt-2">
                        <i class="fas fa-info-circle"></i> 
                        Added ${response.total_chunks_added} document chunks to the index
                    </div>
                `);
            }
            
            if (response.errors && response.errors.length > 0) {
                let errorsList = response.errors.map(e => `<li>${e}</li>`).join('');
                alertDiv.append(`
                    <div class="mt-2">
                        <strong>Errors:</strong>
                        <ul class="text-warning">${errorsList}</ul>
                    </div>
                `);
            }
            
            resultsDiv.append(alertDiv);
        } else {
            resultsDiv.append(`
                <div class="alert alert-error">
                    <i class="fas fa-exclamation-triangle"></i> ${response.error}
                </div>
            `);
        }
    }
    
    function resetUploadForm() {
        selectedFiles = [];
        $('#selectedFiles').hide();
        $('#fileInput').val('');
        $('#uploadBtn').prop('disabled', true);
        
        setTimeout(() => {
            $('#uploadResults').empty();
        }, 10000);
    }
    
    function handleQuery(e) {
        e.preventDefault();
        
        let question = $('#questionInput').val().trim();
        if (!question) return;
        
        let requestData = {
            question: question,
            index_name: currentIndexName,
            k: parseInt($('#maxResults').val()),
            include_sources: $('#includeSources').is(':checked'),
            include_scores: $('#includeScores').is(':checked')
        };
        
        let endpoint = $('#conversationalMode').is(':checked') ? 
                      '/api/conversational-query/' : '/api/query/';
        
        $('#queryProgress').show();
        $('#askBtn').prop('disabled', true);
        $('#resultsSection').hide();
        
        $.ajax({
            url: endpoint,
            type: 'POST',
            data: JSON.stringify(requestData),
            contentType: 'application/json',
            headers: {
                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
            },
            success: function(response) {
                displayQueryResults(response);
                if ($('#conversationalMode').is(':checked')) {
                    conversationHistory.push({
                        question: question,
                        answer: response.answer,
                        timestamp: new Date().toISOString()
                    });
                }
            },
            error: function(xhr) {
                let errorMsg = 'Query failed';
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMsg = xhr.responseJSON.error;
                }
                displayQueryError(errorMsg);
            },
            complete: function() {
                $('#queryProgress').hide();
                $('#askBtn').prop('disabled', false);
            }
        });
    }
    
    function displayQueryResults(response) {
        // Answer
        $('#answerContent').html(response.answer.replace(/\n/g, '<br>'));
        
        // Metadata
        let metrics = '';
        if (response.metadata) {
            metrics = `
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-value">${response.metadata.retrieval_count || 0}</div>
                        <small>Retrieved</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-value">${response.metadata.context_length || 0}</div>
                        <small>Context Length</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-value">${response.metadata.model_used || 'N/A'}</div>
                        <small>Model</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-value">${response.metadata.prompt_length || 0}</div>
                        <small>Prompt Length</small>
                    </div>
                </div>
            `;
        }
        $('#queryMetrics').html(metrics);
        
        // Source documents
        if (response.source_documents && response.source_documents.length > 0) {
            let sourcesHtml = '';
            response.source_documents.forEach((doc, index) => {
                let score = response.confidence_scores ? 
                           response.confidence_scores[index] : null;
                
                sourcesHtml += `
                    <div class="accordion-item mb-3" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);">
                        <h6 class="accordion-header">
                            <button class="btn w-100 text-start text-white" type="button" 
                                    data-bs-toggle="collapse" data-bs-target="#source${index}">
                                <i class="fas fa-file-alt"></i> 
                                Source ${index + 1} - ${doc.metadata.filename || 'Unknown'}
                                ${score !== null ? `<span class="confidence-score float-end">Score: ${score.toFixed(4)}</span>` : ''}
                            </button>
                        </h6>
                        <div id="source${index}" class="collapse">
                            <div class="source-doc">
                                <div class="mb-3">${doc.content.replace(/\n/g, '<br>')}</div>
                                ${Object.keys(doc.metadata).length > 0 ? 
                                  '<strong>Metadata:</strong><br>' + 
                                  Object.entries(doc.metadata).map(([k,v]) => `<strong>${k}:</strong> ${v}`).join('<br>') : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            $('#sourceList').html(sourcesHtml);
            $('#sourceDocuments').show();
        } else {
            $('#sourceDocuments').hide();
        }
        
        $('#resultsSection').show();
        
        // Scroll to results
        $('html, body').animate({
            scrollTop: $('#resultsSection').offset().top - 100
        }, 1000);
    }
    
    function displayQueryError(error) {
        $('#resultsSection').html(`
            <div class="glass-card">
                <div class="alert alert-error">
                    <i class="fas fa-exclamation-triangle"></i> ${error}
                </div>
            </div>
        `).show();
    }
    
    function loadIndexStats() {
        $.ajax({
            url: '/api/index-stats/',
            type: 'GET',
            data: { index_name: currentIndexName },
            success: function(response) {
                if (response.stats) {
                    $('#documentCount').text(response.stats.document_count || 0);
                    $('#chunkCount').text(response.stats.chunk_count || 0);
                }
            },
            error: function() {
                $('#documentCount').text('-');
                $('#chunkCount').text('-');
            }
        });
    }
    
    function clearConversation() {
        $.ajax({
            url: '/api/conversation/',
            type: 'DELETE',
            headers: {
                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
            },
            success: function() {
                conversationHistory = [];
                alert('Conversation cleared successfully!');
            },
            error: function() {
                alert('Failed to clear conversation');
            }
        });
    }
    
    // Sample question handler
    window.setQuestion = function(element) {
        $('#questionInput').val($(element).text().trim());
    }
    
});
</script>
{% endblock %}
