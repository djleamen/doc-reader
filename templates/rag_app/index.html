{% extends 'base.html' %}

{% block content %}
<div class="row">
    
    <!-- Sidebar -->
    <div class="col-md-3">
        <div class="glass-card">
            <h5 class="text-white"><i class="fas fa-cog"></i> Configuration</h5>
            
            <!-- Pipeline Selection -->
            <div class="mb-4">
                <label class="form-label text-white d-flex align-items-center">
                    <i class="fas fa-cloud me-2"></i> RAG Pipeline
                </label>
                <div class="btn-group w-100" role="group" aria-label="Pipeline selection">
                    <input type="radio" class="btn-check" name="pipelineSelect" id="classicPipeline" value="classic" checked>
                    <label class="btn btn-outline-light" for="classicPipeline">
                        <i class="fas fa-server"></i> Classic
                    </label>
                    
                    <input type="radio" class="btn-check" name="pipelineSelect" id="azurePipeline" value="azure">
                    <label class="btn btn-outline-light" for="azurePipeline">
                        <i class="fab fa-microsoft"></i> Azure
                    </label>
                </div>
                <small class="text-white-50 mt-1 d-block">
                    <span id="pipelineBadge" class="badge bg-primary">Classic OpenAI</span>
                </small>
            </div>
            
            <!-- Index Selection -->
            <div class="mb-3">
                <label for="indexSelect" class="form-label text-white">Index Name</label>
                <select class="form-select" id="indexSelect">
                    {% for index in indexes %}
                        <option value="{{ index.name }}" {% if index.name == 'default' %}selected{% endif %}>{{ index.name }}</option>
                    {% empty %}
                        <option value="default" selected>default</option>
                    {% endfor %}
                </select>
                <small class="text-white-50">Select or create document index</small>
            </div>
            
            <!-- Query Settings -->
            <h6 class="text-white mt-4">Query Settings</h6>
            
            <div class="mb-3">
                <label for="maxResults" class="form-label text-white">Max Results</label>
                <input type="range" class="form-range" id="maxResults" min="1" max="20" value="5">
                <small class="text-white-50">Max chunks to retrieve: <span id="maxResultsValue">5</span></small>
            </div>
            
            <div class="form-check mb-2">
                <input class="form-check-input" type="checkbox" id="includeSources" checked>
                <label class="form-check-label text-white" for="includeSources">
                    Include Sources
                </label>
            </div>
            
            <div class="form-check mb-2">
                <input class="form-check-input" type="checkbox" id="includeScores" checked>
                <label class="form-check-label text-white" for="includeScores">
                    Include Confidence Scores
                </label>
            </div>
            
            <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="conversationalMode">
                <label class="form-check-label text-white" for="conversationalMode">
                    Conversational Mode
                </label>
            </div>
            
            <!-- Index Statistics -->
            <h6 class="text-white mt-4">
                <i class="fas fa-chart-bar"></i> Index Statistics
                <button class="btn btn-sm btn-outline-light ms-2" id="refreshStats" title="Refresh Statistics">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </h6>
            
            <div id="indexStats" class="mt-3">
                <div class="stat-card">
                    <div class="stat-value" id="documentCount">-</div>
                    <small>Documents</small>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="chunkCount">-</div>
                    <small>Chunks</small>
                </div>
            </div>
            
            <!-- Document Management -->
            <div class="mt-4">
                <button class="btn btn-danger btn-sm w-100" id="clearDocuments" title="Clear all documents and chunks from this index">
                    <i class="fas fa-trash-alt"></i> Clear All Documents
                </button>
            </div>
            
            <!-- Clear Conversation -->
            <div id="conversationalControls" class="mt-3 hidden">
                <button class="btn btn-warning btn-sm w-100" id="clearConversation">
                    <i class="fas fa-comments"></i> Clear Conversation
                </button>
            </div>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="col-md-9">
        
        <!-- Document Upload Section -->
        <div class="glass-card">
            <h5 class="text-white"><i class="fas fa-upload"></i> Upload Documents</h5>
            
            <form id="uploadForm" enctype="multipart/form-data">
                {% csrf_token %}
                
                <div class="drag-drop-area" id="dragDropArea">
                    <i class="fas fa-cloud-upload-alt fa-3x mb-3"></i>
                    <h6 class="text-white">Drag & drop files here or click to select</h6>
                    <p class="text-white-50">
                        Supported formats: {{ supported_formats|join:", "|upper }}
                        <br>
                        Max file size: {{ max_file_size_mb }} MB
                    </p>
                    <input type="file" id="fileInput" multiple 
                           accept=".pdf,.docx,.txt,.md"
                           class="hidden"
                           aria-label="Select files to upload">
                </div>
                
                <!-- Selected Files -->
                <div id="selectedFiles" class="mt-3 hidden">
                    <h6 class="text-white">Selected Files:</h6>
                    <ul id="fileList" class="list-group"></ul>
                </div>
                
                <!-- Upload Button -->
                <div class="mt-3 text-center">
                    <button type="button" id="uploadBtn" class="btn btn-primary btn-lg" disabled>
                        <i class="fas fa-rocket"></i> Process Documents
                    </button>
                </div>
                
                <!-- Upload Progress -->
                <div id="uploadProgress" class="mt-3 hidden">
                    <progress class="progress-bar progress-bar-striped progress-bar-animated w-100" 
                             value="0" 
                             max="100"
                             aria-label="Document upload progress"></progress>
                    <div class="text-center text-white mt-2">
                        <span id="uploadStatus">Processing...</span>
                    </div>
                </div>
                
                <!-- Upload Results -->
                <div id="uploadResults" class="mt-3"></div>
            </form>
        </div>
        
        <!-- Query Section -->
        <div class="glass-card">
            <h5 class="text-white"><i class="fas fa-question-circle"></i> Ask Questions</h5>
            
            <!-- Sample Questions -->
            <div class="mb-3">
                <h6 class="text-white">
                    <i class="fas fa-lightbulb"></i> Sample Questions
                    <button class="btn btn-sm btn-outline-light ms-2" type="button" 
                            data-bs-toggle="collapse" data-bs-target="#sampleQuestions"
                            title="Toggle sample questions">
                        <i class="fas fa-chevron-down"></i>
                    </button>
                </h6>
                
                <div class="collapse" id="sampleQuestions">
                    <button class="sample-question btn btn-link text-start w-100" onclick="setQuestion(this)" type="button">
                        What are the main topics covered in the documents?
                    </button>
                    <button class="sample-question btn btn-link text-start w-100" onclick="setQuestion(this)" type="button">
                        Can you summarize the key findings?
                    </button>
                    <button class="sample-question btn btn-link text-start w-100" onclick="setQuestion(this)" type="button">
                        What methodology was used in the research?
                    </button>
                    <button class="sample-question btn btn-link text-start w-100" onclick="setQuestion(this)" type="button">
                        What are the conclusions and recommendations?
                    </button>
                </div>
            </div>
            
            <!-- Query Form -->
            <form id="queryForm">
                {% csrf_token %}
                <div class="mb-3">
                    <label for="questionInput" class="form-label text-white">Your Question:</label>
                    <textarea class="form-control" id="questionInput" rows="3" 
                              placeholder="Ask any question about your uploaded documents..."></textarea>
                </div>
                
                <div class="text-center">
                    <button type="submit" class="btn btn-primary btn-lg" id="askBtn">
                        <i class="fas fa-search"></i> Ask Question
                    </button>
                </div>
            </form>
            
            <!-- Query Progress -->
            <div id="queryProgress" class="text-center mt-3 hidden">
                <div class="spinner-border"></div>
                <div class="text-white mt-2">Searching for answers...</div>
            </div>
        </div>
        
        <!-- Results Section -->
        <div id="resultsSection" class="hidden">
            
            <!-- Answer -->
            <div class="glass-card">
                <h5 class="text-white"><i class="fas fa-comment-dots"></i> Answer</h5>
                <div id="answerContent" class="text-white"></div>
            </div>
            
            <!-- Query Details -->
            <div class="glass-card">
                <h6 class="text-white">
                    <i class="fas fa-chart-line"></i> Query Details
                    <button class="btn btn-sm btn-outline-light ms-2" type="button"
                            data-bs-toggle="collapse" data-bs-target="#queryDetails"
                            title="Toggle query details">
                        <i class="fas fa-chevron-down"></i>
                    </button>
                </h6>
                
                <div class="collapse" id="queryDetails">
                    <div class="row text-center" id="queryMetrics">
                        <!-- Metrics will be populated by JavaScript -->
                    </div>
                </div>
            </div>
            
            <!-- Source Documents -->
            <div id="sourceDocuments" class="glass-card hidden">
                <h5 class="text-white"><i class="fas fa-book"></i> Source Chunks</h5>
                <div id="sourceList">
                    <!-- Source documents will be populated by JavaScript -->
                </div>
            </div>
            
        </div>
        
    </div>
    
</div>

<!-- Conversation History Modal -->
<div class="modal fade" id="conversationModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content modal-glass">
            <div class="modal-header border-0">
                <h5 class="modal-title text-white">
                    <i class="fas fa-comments"></i> Conversation History
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" title="Close"></button>
            </div>
            <div class="modal-body">
                <div id="conversationHistory" class="text-white">
                    <!-- Conversation history will be populated here -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Global pipeline state
let currentPipeline = 'classic'; // 'classic' or 'azure'

// Utility functions in outer scope
function displayUploadResults(response, type) {
    let resultsDiv = $('#uploadResults');
    resultsDiv.empty();
    
    if (type === 'success') {
        let alertDiv = $(`
            <div class="alert alert-success">
                <i class="fas fa-check-circle"></i> ${response.message}
            </div>
        `);
        
        if (response.files_processed && response.files_processed.length > 0) {
            let filesList = response.files_processed.map(f => `<li>${f}</li>`).join('');
            alertDiv.append(`
                <div class="mt-2">
                    <strong>Processed files:</strong>
                    <ul>${filesList}</ul>
                </div>
            `);
        }
        
        if (response.total_chunks_added > 0) {
            alertDiv.append(`
                <div class="mt-2">
                    <i class="fas fa-info-circle"></i> 
                    Added ${response.total_chunks_added} document chunks to the index
                </div>
            `);
        }
        
        if (response.errors && response.errors.length > 0) {
            let errorsList = response.errors.map(e => `<li>${e}</li>`).join('');
            alertDiv.append(`
                <div class="mt-2">
                    <strong>Errors:</strong>
                    <ul class="text-warning">${errorsList}</ul>
                </div>
            `);
        }
        
        resultsDiv.append(alertDiv);
    } else {
        resultsDiv.append(`
            <div class="alert alert-error">
                <i class="fas fa-exclamation-triangle"></i> ${response.error}
            </div>
        `);
    }
}

function displayQueryResults(response) {
    // Answer
    $('#answerContent').html(response.answer.replaceAll('\n', '<br>'));
    
    // Metadata
    let metrics = '';
    if (response.metadata) {
        metrics = `
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-value">${response.metadata.retrieval_count || 0}</div>
                    <small>Retrieved</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-value">${response.metadata.context_length || 0}</div>
                    <small>Context Length</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-value">${response.metadata.model_used || 'N/A'}</div>
                    <small>Model</small>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-value">${response.metadata.prompt_length || 0}</div>
                    <small>Prompt Length</small>
                </div>
            </div>
        `;
    }
    $('#queryMetrics').html(metrics);
    
    // Source documents
    if (response.source_documents && response.source_documents.length > 0) {
        let sourcesHtml = '';
        for (const [index, doc] of response.source_documents.entries()) {
            let score = response.confidence_scores ? 
                       response.confidence_scores[index] : null;
            
            sourcesHtml += `
                <div class="accordion-item mb-3" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);">
                    <h6 class="accordion-header">
                        <button class="btn w-100 text-start text-white" type="button" 
                                data-bs-toggle="collapse" data-bs-target="#source${index}">
                            <i class="fas fa-file-alt"></i> 
                            Chunk ${index + 1} - ${doc.metadata.filename || 'Unknown'}
                            ${score === null ? '' : `<span class="confidence-score float-end">Score: ${score.toFixed(4)}</span>`}
                        </button>
                    </h6>
                    <div id="source${index}" class="collapse">
                        <div class="source-doc">
                            <div class="mb-3">${doc.content.replaceAll('\n', '<br>')}</div>
                            ${Object.keys(doc.metadata).length > 0 ? 
                              '<strong>Metadata:</strong><br>' + 
                              Object.entries(doc.metadata).map(([k,v]) => `<strong>${k}:</strong> ${v}`).join('<br>') : ''}
                        </div>
                    </div>
                </div>
            `;
        }
        $('#sourceList').html(sourcesHtml);
        $('#sourceDocuments').show();
    } else {
        $('#sourceDocuments').hide();
    }
    
    $('#resultsSection').show();
    
    // Scroll to results
    $('html, body').animate({
        scrollTop: $('#resultsSection').offset().top - 100
    }, 1000);
}

function displayQueryError(error) {
    $('#resultsSection').html(`
        <div class="glass-card">
            <div class="alert alert-error">
                <i class="fas fa-exclamation-triangle"></i> ${error}
            </div>
        </div>
    `).show();
}

globalThis.removeFile = function(index) {
    const fileInputEl = document.getElementById('fileInput');
    const changeEvent = new Event('change', { bubbles: true });
    
    // Update the file input element
    if (fileInputEl && fileInputEl.files) {
        const dt = new DataTransfer();
        const files = Array.from(fileInputEl.files);
        
        for (const [i, file] of files.entries()) {
            if (i !== index) {
                dt.items.add(file);
            }
        }
        
        fileInputEl.files = dt.files;
        fileInputEl.dispatchEvent(changeEvent);
    }
}

globalThis.setQuestion = function(element) {
    $('#questionInput').val($(element).text().trim());
}

function updatePipelineBadge() {
    const badge = $('#pipelineBadge');
    if (currentPipeline === 'azure') {
        badge.removeClass('bg-primary').addClass('bg-info');
        badge.html('<i class="fab fa-microsoft"></i> Azure AI');
    } else {
        badge.removeClass('bg-info').addClass('bg-primary');
        badge.html('<i class="fas fa-server"></i> Classic OpenAI');
    }
}

function getApiEndpoint(endpoint) {
    // Map endpoints to their Azure or classic versions
    const endpointMap = {
        'upload': currentPipeline === 'azure' ? '/api/azure/upload-documents/' : '/api/upload-documents/',
        'query': currentPipeline === 'azure' ? '/api/azure/query/' : '/api/query/',
        'conversational': currentPipeline === 'azure' ? '/api/azure/conversational-query/' : '/api/conversational-query/',
        'stats': currentPipeline === 'azure' ? '/api/azure/index-stats/' : '/api/index-stats/',
        'clear-conversation': currentPipeline === 'azure' ? '/api/azure/clear-conversation/' : '/api/conversation/',
        'clear-documents': currentPipeline === 'azure' ? '/api/azure/clear-cache/' : '/api/clear-documents/'
    };
    return endpointMap[endpoint] || endpoint;
}

function clearConversation() {
    $.ajax({
        url: getApiEndpoint('clear-conversation'),
        type: 'DELETE',
        headers: {
            'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
        },
        success: function() {
            alert('Conversation cleared successfully!');
        },
        error: function() {
            alert('Failed to clear conversation');
        }
    });
}

function clearAllDocuments(currentIndexName) {
    if (!confirm(`⚠️ WARNING: This will permanently delete all documents and chunks from the "${currentIndexName}" index.\n\nThis action cannot be undone. Are you sure you want to continue?`)) {
        return;
    }
    
    $('#clearDocuments').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Clearing...');
    
    $.ajax({
        url: getApiEndpoint('clear-documents'),
        type: 'DELETE',
        data: { index_name: currentIndexName },
        headers: {
            'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
        },
        success: function(response) {
            alert(response.message || 'All documents cleared successfully!');
            if (typeof loadIndexStats === 'function') {
                loadIndexStats();
            }
            $('#resultsSection').hide();
        },
        error: function(xhr) {
            const errorMsg = xhr.responseJSON?.error || 'Failed to clear documents';
            alert('Error: ' + errorMsg);
        },
        complete: function() {
            $('#clearDocuments').prop('disabled', false).html('<i class="fas fa-trash-alt"></i> Clear All Documents');
        }
    });
}

$(document).ready(function() {
    let selectedFiles = [];
    let currentIndexName = 'default';
    
    // Initialize
    initializeEventListeners();
    loadIndexStats();
    
    function initializeEventListeners() {
        // File input handling
        $('#dragDropArea').on('click', function(e) {
            // Only trigger file input if not already clicking on the input itself
            if (e.target.id !== 'fileInput') {
                $('#fileInput').click();
            }
        });
        
        $('#fileInput').on('change', handleFileSelection);
        
        // Drag and drop
        $('#dragDropArea').on('dragover', function(e) {
            e.preventDefault();
            $(this).addClass('drag-over');
        });
        
        $('#dragDropArea').on('dragleave', function(e) {
            e.preventDefault();
            $(this).removeClass('drag-over');
        });
        
        $('#dragDropArea').on('drop', function(e) {
            e.preventDefault();
            $(this).removeClass('drag-over');
            handleFileSelection(e);
        });
        
        // Form submissions
        $('#uploadBtn').on('click', uploadDocuments);
        $('#queryForm').on('submit', handleQuery);
        
        // Settings
        $('#maxResults').on('input', function() {
            $('#maxResultsValue').text($(this).val());
        });
        
        $('#conversationalMode').on('change', function() {
            $('#conversationalControls').toggle($(this).is(':checked'));
        });
        
        $('#indexSelect').on('change', function() {
            currentIndexName = $(this).val();
            loadIndexStats();
        });
        
        // Pipeline switching
        $('input[name="pipelineSelect"]').on('change', function() {
            currentPipeline = $(this).val();
            updatePipelineBadge();
            loadIndexStats();
        });
        
        // Actions
        $('#refreshStats').on('click', loadIndexStats);
        $('#clearConversation').on('click', clearConversation);
        $('#clearDocuments').on('click', function() {
            clearAllDocuments(currentIndexName);
        });
    }
    
    function handleFileSelection(e) {
        let files = e.target.files || e.originalEvent.dataTransfer.files;
        selectedFiles = Array.from(files);
        
        if (selectedFiles.length > 0) {
            displaySelectedFiles();
            $('#uploadBtn').prop('disabled', false);
        }
    }
    
    function displaySelectedFiles() {
        let fileList = $('#fileList');
        fileList.empty();
        
        for (const [index, file] of selectedFiles.entries()) {
            let listItem = $(`
                <li class="list-group-item d-flex justify-content-between align-items-center file-list-item">
                    <span>
                        <i class="fas fa-file"></i> ${file.name} 
                        <small>(${(file.size / 1024 / 1024).toFixed(2)} MB)</small>
                    </span>
                    <button class="btn btn-sm btn-outline-danger" onclick="globalThis.removeFile(${index})" title="Remove file" type="button">
                        <i class="fas fa-times"></i>
                    </button>
                </li>
            `);
            fileList.append(listItem);
        }
        
        $('#selectedFiles').show();
    }
    
    function uploadDocuments() {
        if (selectedFiles.length === 0) return;
        
        let formData = new FormData();
        formData.append('index_name', currentIndexName);
        
        for (const file of selectedFiles) {
            formData.append('files', file);
        }
        
        // Add CSRF token
        formData.append('csrfmiddlewaretoken', $('[name=csrfmiddlewaretoken]').val());
        
        $('#uploadProgress').show();
        $('#uploadBtn').prop('disabled', true);
        
        $.ajax({
            url: getApiEndpoint('upload'),
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            xhr: function() {
                let xhr = new globalThis.XMLHttpRequest();
                xhr.upload.addEventListener("progress", function(evt) {
                    if (evt.lengthComputable) {
                        let percentComplete = evt.loaded / evt.total * 100;
                        $('.progress-bar').css('width', percentComplete + '%');
                    }
                }, false);
                return xhr;
            },
            success: function(response) {
                displayUploadResults(response, 'success');
                loadIndexStats();
                resetUploadForm();
            },
            error: function(xhr) {
                let errorMsg = 'Upload failed';
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMsg = xhr.responseJSON.error;
                }
                displayUploadResults({error: errorMsg}, 'error');
                $('#uploadBtn').prop('disabled', false);
            },
            complete: function() {
                $('#uploadProgress').hide();
                $('.progress-bar').css('width', '0%');
            }
        });
    }
    
    function resetUploadForm() {
        selectedFiles = [];
        $('#selectedFiles').hide();
        $('#fileInput').val('');
        $('#uploadBtn').prop('disabled', true);
        
        setTimeout(() => {
            $('#uploadResults').empty();
        }, 10000);
    }
    
    function handleQuery(e) {
        e.preventDefault();
        
        let question = $('#questionInput').val().trim();
        if (question === '') return;
        
        let requestData = {
            question: question,
            index_name: currentIndexName,
            k: Number.parseInt($('#maxResults').val(), 10),
            include_sources: $('#includeSources').is(':checked'),
            include_scores: $('#includeScores').is(':checked')
        };
        
        let endpointType = $('#conversationalMode').is(':checked') ? 'conversational' : 'query';
        let endpoint = getApiEndpoint(endpointType);
        
        $('#queryProgress').show();
        $('#askBtn').prop('disabled', true);
        $('#resultsSection').hide();
        
        $.ajax({
            url: endpoint,
            type: 'POST',
            data: JSON.stringify(requestData),
            contentType: 'application/json',
            headers: {
                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
            },
            success: function(response) {
                displayQueryResults(response);
            },
            error: function(xhr) {
                let errorMsg = 'Query failed';
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMsg = xhr.responseJSON.error;
                }
                displayQueryError(errorMsg);
            },
            complete: function() {
                $('#queryProgress').hide();
                $('#askBtn').prop('disabled', false);
            }
        });
    }
    
    function loadIndexStats() {
        $.ajax({
            url: getApiEndpoint('stats'),
            type: 'GET',
            data: { index_name: currentIndexName },
            success: function(response) {
                if (response.stats) {
                    $('#documentCount').text(response.stats.document_count || 0);
                    $('#chunkCount').text(response.stats.chunk_count || 0);
                }
            },
            error: function() {
                $('#documentCount').text('-');
                $('#chunkCount').text('-');
            }
        });
    }
    
});
</script>
{% endblock %}
